name: Reusable Kernel Tests

on:
  workflow_call:
    inputs:
      rust-toolchain:
        description: 'Rust toolchain version'
        required: false
        type: string
        default: 'nightly'
      kboot-features:
        description: 'Features to enable when installing kboot'
        required: false
        type: string
        default: 'ci'
      cargo-test-args:
        description: 'Additional arguments to pass to cargo test'
        required: false
        type: string
        default: ''
    outputs:
      test-results-found:
        description: 'Whether test results were found'
        value: ${{ jobs.test.outputs.results-found }}
      total-failures:
        description: 'Total number of test failures'
        value: ${{ jobs.test.outputs.total-failures }}

jobs:
  test:
    # ✅ Changed from ubuntu-latest
    runs-on: windows-2025

    outputs:
      results-found: ${{ steps.find-results.outputs.results_dir != '' }}
      total-failures: ${{ steps.check-failures.outputs.failed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rustup
        shell: powershell
        run: |
          Invoke-WebRequest https://win.rustup.rs -OutFile rustup-init.exe
          .\rustup-init.exe -y --default-toolchain ${{ inputs.rust-toolchain }}

      - name: Add Rust to PATH
        shell: powershell
        run: echo "$env:USERPROFILE\.cargo\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Set up Rust toolchain components
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ inputs.rust-toolchain }}
          components: rust-src, llvm-tools-preview

      - name: Print Rust details
        shell: powershell
        run: |
          rustup show
          rustc --version
          cargo --version

      - name: Install kboot
        shell: powershell
        run: cargo install kboot --features "${{ inputs.kboot-features }}"

      - name: Install cargo-hack
        shell: powershell
        run: cargo install cargo-hack

      - name: Run kernel tests
        shell: powershell
        run: cargo hack test --workspace ${{ inputs.cargo-test-args }}

      - name: Debug - List directories
        if: always()
        shell: powershell
        run: |
          Write-Host "Listing directories:"
          Get-ChildItem -Recurse

      - name: Parse test results
        if: always()
        shell: powershell
        run: |
          Add-Content $env:GITHUB_STEP_SUMMARY "## Test Results Summary"

          # Install jq if missing
          if (-not (Get-Command jq.exe -ErrorAction SilentlyContinue)) {
            Write-Host "Installing jq..."
            Invoke-WebRequest -Uri "https://github.com/stedolan/jq/releases/download/jq-1.6/jq-win64.exe" -OutFile "jq.exe"
          }

          $patterns = @(
            ".build\testing-*",
            "target\.build\testing-*",
            "testing-*",
            ".ktest\testing-*"
          )

          $latest = ""

          foreach ($p in $patterns) {
            $found = Get-ChildItem -Path . -Recurse -Directory -Filter "testing-*" -ErrorAction SilentlyContinue | Sort-Object FullName -Descending | Select-Object -First 1
            if ($found) {
              $latest = $found.FullName
              break
            }
          }

          if ($latest -and (Test-Path $latest)) {
            Add-Content $env:GITHUB_STEP_SUMMARY "Found test results in: $latest"

            $jsonFiles = Get-ChildItem "$latest\*.json" -ErrorAction SilentlyContinue
            foreach ($file in $jsonFiles) {
              Add-Content $env:GITHUB_STEP_SUMMARY "### $($file.Name)"

              $total   = jq -r ".summary.total // 0" $file.FullName
              $passed  = jq -r ".summary.passed // 0" $file.FullName
              $failed  = jq -r ".summary.failed // 0" $file.FullName
              $ignored = jq -r ".summary.ignored // 0" $file.FullName
              $duration = jq -r ".summary.duration // \"N/A\"" $file.FullName

              Add-Content $env:GITHUB_STEP_SUMMARY "- **Total:** $total"
              Add-Content $env:GITHUB_STEP_SUMMARY "- **Passed:** ✅ $passed"
              Add-Content $env:GITHUB_STEP_SUMMARY "- **Failed:** ❌ $failed"
              Add-Content $env:GITHUB_STEP_SUMMARY "- **Ignored:** ⏭️ $ignored"
              Add-Content $env:GITHUB_STEP_SUMMARY "- **Duration:** ${duration}ms`n"

              if ($failed -gt 0) {
                Add-Content $env:GITHUB_STEP_SUMMARY "#### Failed tests:"
                jq -r '.modules[]?.tests[]? | select(.result == "fail") | "- **\(.test)**: \(.message // "No message") (\(.location // "unknown location"))"' $file.FullName | Add-Content $env:GITHUB_STEP_SUMMARY
                Add-Content $env:GITHUB_STEP_SUMMARY ""
              }
            }
          }
          else {
            Add-Content $env:GITHUB_STEP_SUMMARY "⚠️ No test results found"
          }

      - name: Find test results directory
        if: always()
        id: find-results
        shell: powershell
        run: |
          $dir = Get-ChildItem ".build" -Directory -Filter "testing-*" -ErrorAction SilentlyContinue | Sort-Object FullName -Descending | Select-Object -First 1
          if ($dir) {
            echo "results_dir=$($dir.FullName)" >> $env:GITHUB_OUTPUT
          } else {
            echo "results_dir=" >> $env:GITHUB_OUTPUT
          }

      - name: Upload test results
        if: always() && steps.find-results.outputs.results_dir != ''
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ${{ steps.find-results.outputs.results_dir }}
          if-no-files-found: warn

      - name: Check for test failures
        if: always()
        id: check-failures
        shell: powershell
        run: |
          $dir = "${{ steps.find-results.outputs.results_dir }}"
          if (-not $dir -or -not (Test-Path $dir)) {
            echo "failed=0" >> $env:GITHUB_OUTPUT
            exit 0
          }

          if (-not (Get-Command jq.exe -ErrorAction SilentlyContinue)) {
            Invoke-WebRequest -Uri "https://github.com/stedolan/jq/releases/download/jq-1.6/jq-win64.exe" -OutFile "jq.exe"
          }

          $failed = 0
          $files = Get-ChildItem "$dir\*.json" -ErrorAction SilentlyContinue
          foreach ($file in $files) {
            $count = jq -r ".summary.failed // 0" $file.FullName
            $failed += $count
          }

          echo "failed=$failed" >> $env:GITHUB_OUTPUT

          if ($failed -gt 0) {
            exit 1
          }