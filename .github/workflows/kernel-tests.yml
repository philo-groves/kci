
name: Reusable Kernel Tests

on:
  workflow_call:
    inputs:
      rust-toolchain:
        description: 'Rust toolchain version'
        required: false
        type: string
        default: 'nightly'
      kboot-features:
        description: 'Features to enable when installing kboot'
        required: false
        type: string
        default: 'ci'
      cargo-test-args:
        description: 'Additional arguments to pass to cargo test'
        required: false
        type: string
        default: ''
    outputs:
      test-results-found:
        description: 'Whether test results were found'
        value: ${{ jobs.test.outputs.results-found }}
      total-failures:
        description: 'Total number of test failures'
        value: ${{ jobs.test.outputs.total-failures }}

jobs:
  test:
    runs-on: windows-2025
    outputs:
      results-found: ${{ steps.find-results.outputs.results_dir != '' }}
      total-failures: ${{ steps.check-failures.outputs.failed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://win.rustup.rs/x86_64 -OutFile rustup-init.exe
          .\rustup-init.exe -y --default-toolchain nightly
          Remove-Item rustup-init.exe

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ inputs.rust-toolchain }}
          components: rust-src, llvm-tools-preview
      
      - name: Print Rust Details
        shell: pwsh
        run: |
          rustup show
          rustc --version
          cargo --version

      - name: Install kboot
        shell: pwsh
        run: cargo install kboot --features "${{ inputs.kboot-features }}"
      
      - name: Run kernel tests
        shell: pwsh
        run: cargo test ${{ inputs.cargo-test-args }}
      
      # Debug step to see what was actually created
      - name: Debug - List build directory
        if: always()
        shell: pwsh
        run: |
          Write-Output "Contents of current directory:"
          Get-ChildItem -Force
          Write-Output ""
          Write-Output "Searching for .build directory:"
          Get-ChildItem -Recurse -Directory -Filter ".build" -ErrorAction SilentlyContinue | Select-Object FullName
          Write-Output ""
          Write-Output "Searching for testing-* directories:"
          Get-ChildItem -Recurse -Directory -Filter "testing-*" -ErrorAction SilentlyContinue | Select-Object FullName
          Write-Output ""
          Write-Output "Searching for *.json files:"
          Get-ChildItem -Recurse -Filter "*.json" -ErrorAction SilentlyContinue | Select-Object FullName
      
      - name: Parse test results
        if: always()
        shell: pwsh
        run: |
          "## Test Results Summary" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          
          # Try multiple possible locations for test results
          $possiblePatterns = @(
            ".build\testing-*",
            "target\.build\testing-*",
            "testing-*",
            ".ktest\testing-*"
          )
          
          $latestDir = $null
          foreach ($pattern in $possiblePatterns) {
            $foundDirs = Get-ChildItem -Path . -Directory -Filter ($pattern.Split('\')[-1]) -Recurse -ErrorAction SilentlyContinue | 
                         Where-Object { $_.FullName -like "*$($pattern.Replace('\','*'))" } |
                         Sort-Object LastWriteTime -Descending |
                         Select-Object -First 1
            
            if ($foundDirs) {
              $latestDir = $foundDirs.FullName
              break
            }
          }
          
          if ($latestDir -and (Test-Path $latestDir)) {
            "Found test results in: $latestDir" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            
            $jsonFiles = Get-ChildItem -Path $latestDir -Filter "*.json"
            
            foreach ($resultFile in $jsonFiles) {
              "### $($resultFile.Name)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              
              # Parse JSON and extract summary
              $json = Get-Content $resultFile.FullName -Raw | ConvertFrom-Json
              
              $total = if ($json.summary.total) { $json.summary.total } else { 0 }
              $passed = if ($json.summary.passed) { $json.summary.passed } else { 0 }
              $failed = if ($json.summary.failed) { $json.summary.failed } else { 0 }
              $ignored = if ($json.summary.ignored) { $json.summary.ignored } else { 0 }
              $duration = if ($json.summary.duration) { $json.summary.duration } else { "N/A" }
              
              "- **Total Tests:** $total" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              "- **Passed:** ✅ $passed" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              "- **Failed:** ❌ $failed" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              "- **Ignored:** ⏭️ $ignored" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              "- **Duration:** ${duration}ms" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              
              # List failed tests if any
              if ($failed -gt 0) {
                "#### Failed Tests:" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
                foreach ($module in $json.modules) {
                  foreach ($test in $module.tests) {
                    if ($test.result -eq "fail") {
                      $message = if ($test.message) { $test.message } else { "No message" }
                      $location = if ($test.location) { $test.location } else { "unknown location" }
                      "- **$($test.test)**: $message ($location)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
                    }
                  }
                }
                "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              }
            }
          } else {
            "⚠️ No test results found in any expected location" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "This could mean:" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "- Tests didn't run with ktest" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "- Output directory configuration is different" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "- Tests completed but didn't generate JSON output" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }
      
      - name: Find test results directory
        if: always()
        id: find-results
        shell: pwsh
        run: |
          $latestDir = Get-ChildItem -Path .build -Directory -Filter "testing-*" -ErrorAction SilentlyContinue | 
                       Sort-Object LastWriteTime -Descending | 
                       Select-Object -First 1 | 
                       Select-Object -ExpandProperty FullName
          
          "results_dir=$latestDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Output "Found results directory: $latestDir"
      
      - name: Upload test results
        if: always() && steps.find-results.outputs.results_dir != ''
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ${{ steps.find-results.outputs.results_dir }}
          if-no-files-found: warn
      
      - name: Check for test failures
        if: always()
        id: check-failures
        shell: pwsh
        run: |
          # Use the results directory we found earlier
          $resultsDir = "${{ steps.find-results.outputs.results_dir }}"
          
          if ($resultsDir -and (Test-Path $resultsDir)) {
            Write-Output "Checking test results in: $resultsDir"
            
            $failed = 0
            $jsonFiles = Get-ChildItem -Path $resultsDir -Filter "*.json"
            
            foreach ($resultFile in $jsonFiles) {
              Write-Output "Processing: $($resultFile.Name)"
              $json = Get-Content $resultFile.FullName -Raw | ConvertFrom-Json
              $failures = if ($json.summary.failed) { $json.summary.failed } else { 0 }
              Write-Output "  Failures in this file: $failures"
              $failed += $failures
            }
            
            Write-Output "Total failures across all test files: $failed"
            "failed=$failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            
            if ($failed -gt 0) {
              Write-Output "❌ $failed test(s) failed"
              exit 1
            } else {
              Write-Output "✅ All tests passed"
            }
          } else {
            Write-Output "⚠️ No test results found"
            Write-Output "This might mean tests didn't generate JSON output"
            "failed=0" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            # Don't fail if no JSON output - rely on cargo test exit code instead
            Write-Output "Relying on cargo test exit code..."
          }